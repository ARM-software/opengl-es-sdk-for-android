<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OpenGL ES SDK for Android: High Quality Text Rendering</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function()
{ (i[r].q=i[r].q||[]).push(arguments)}
,i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-35797182-1', 'auto');
ga('send', 'pageview');
</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="top_banner.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenGL ES SDK for Android
<span id="armdevcenter"><a href="https://developer.arm.com/">ARM Developer Center</a></span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li class="current"><a href="pages.html"><span>Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('high_quality_text.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">High Quality Text Rendering </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Improving quality for textured text.</p>
<div class="image">
<img src="HighQualityTextHeader.png" alt="HighQualityTextHeader.png"/>
</div>
<h1><a class="anchor" id="highQualityTextIntroduction"></a>
Introduction</h1>
<p>The source for this sample can be found in the folder of the SDK.</p>
<p>Preserving the highest possible quality text in real-time 3D graphics is challenging. Objects may change their position, rotation, scale and viewing angle dynamically. All these have a negative impact on quality because text is usually generated once, not in every frame. Generating a texture for the whole text takes a long time depending on the font engine and its performance. Usually this amount of time is enough to affect performance.</p>
<p>This document presents an approach of how to achieve the best possible quality of text when the object is semi-dynamic. A semi-dynamic object is an object which is being changed neither too often (not every frame) nor during animation time.</p>
<p>This sample describes how to calculate font size, which should give a close matching of texels onto screen pixels.</p>
<p>We are going to use the font engine which is part of Android. The font engine produces an RGBA image which contains the shape of the whole text. Then the image is uploaded into a texture and next the texture is mapped on a rectangle. The rectangle geometry must have an appropriate aspect ratio defined according to the texture size.</p>
<h1><a class="anchor" id="highQualityTextEvaluationAFontSize"></a>
Evaluating A Font Size</h1>
<p>To evaluate the font size for a current transformation of the object we need to have four corners of a rectangle transformed from 3D world space into 2D pixel screen space. Having corners expressed in pixels we can calculate the distance between two left corners and the distance between two right corners. Then an average value is being calculated from those distances. The average value is what we are looking for, as this is the size of the font we are going to use to generate the image.</p>
<div class="fragment"><div class="line">        <span class="comment">// 1. Calculate bounding box in screen coordinates with current matrices</span></div>
<div class="line">        Vector4f cLT = <span class="keyword">new</span> Vector4f(-0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>,-0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 0.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 1.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>);</div>
<div class="line">        Vector4f cLB = <span class="keyword">new</span> Vector4f(-0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 0.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 1.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>);</div>
<div class="line">        Vector4f cRT = <span class="keyword">new</span> Vector4f( 0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>,-0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 0.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 1.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>);</div>
<div class="line">        Vector4f cRB = <span class="keyword">new</span> Vector4f( 0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 0.5<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 0.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>, 1.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Instead of calculating matrices again lets reuse ones which were already calculated</span></div>
<div class="line">        <span class="comment">// for rendering purpose. One important thing is the update() method must be called</span></div>
<div class="line">        <span class="comment">// after render() method</span></div>
<div class="line">        cLT.makePixelCoords(mMVPMatrix, theViewportWidth, theViewportHeight);</div>
<div class="line">        cLB.makePixelCoords(mMVPMatrix, theViewportWidth, theViewportHeight);</div>
<div class="line">        cRT.makePixelCoords(mMVPMatrix, theViewportWidth, theViewportHeight);</div>
<div class="line">        cRB.makePixelCoords(mMVPMatrix, theViewportWidth, theViewportHeight);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 2. Evaluate font size based on the height of bounding box corners</span></div>
<div class="line">        Vector4f vl = Vector4f.sub(cLB, cLT);</div>
<div class="line">        Vector4f vr = Vector4f.sub(cRB, cRT);</div>
<div class="line">        textSize = (vl.length3() + vr.length3()) / 2.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>;</div>
</div><!-- fragment --><p> Below is a definition of the makePixelCoords method from the Vector4f class. The method transforms a 3D vertex position onto a 2D pixel position.</p>
<div class="fragment"><div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> makePixelCoords(<span class="keywordtype">float</span>[] aMatrix,</div>
<div class="line">                                <span class="keywordtype">int</span> aViewportWidth,</div>
<div class="line">                                <span class="keywordtype">int</span> aViewportHeight) {</div>
<div class="line">        <span class="comment">// Transform the vector into screen coordinates we assumes aMatrix is ModelViewProjection matrix</span></div>
<div class="line">        <span class="comment">// transform method multiplies this vector by the matrix</span></div>
<div class="line">        transform(aMatrix);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Make coordinates as homogenous</span></div>
<div class="line">        <a class="code" href="gl2ext_8h.html#abe1577120f1766eff913e9a74879f373">x</a> /= <a class="code" href="gl2ext_8h.html#afb1b07e1b25035d41d60fb2c03d507e6">w</a>;</div>
<div class="line">        <a class="code" href="gl2ext_8h.html#a1675d9d7bb68e1657ff028643b4037e3">y</a> /= <a class="code" href="gl2ext_8h.html#afb1b07e1b25035d41d60fb2c03d507e6">w</a>;</div>
<div class="line">        z /= <a class="code" href="gl2ext_8h.html#afb1b07e1b25035d41d60fb2c03d507e6">w</a>;</div>
<div class="line">        <a class="code" href="gl2ext_8h.html#afb1b07e1b25035d41d60fb2c03d507e6">w</a> = 1.0f;</div>
<div class="line">        <span class="comment">// Now the vector is normalized to the range [-1.0, 1.0]</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Normalize values into NDC.</span></div>
<div class="line">        <a class="code" href="gl2ext_8h.html#abe1577120f1766eff913e9a74879f373">x</a> = 0.5f + <a class="code" href="gl2ext_8h.html#abe1577120f1766eff913e9a74879f373">x</a> * 0.5f;</div>
<div class="line">        <a class="code" href="gl2ext_8h.html#a1675d9d7bb68e1657ff028643b4037e3">y</a> = 0.5f + <a class="code" href="gl2ext_8h.html#a1675d9d7bb68e1657ff028643b4037e3">y</a> * 0.5f;</div>
<div class="line">        z = 0.5f + z * 0.5f;</div>
<div class="line">        <a class="code" href="gl2ext_8h.html#afb1b07e1b25035d41d60fb2c03d507e6">w</a> = 1.0f;</div>
<div class="line">        <span class="comment">// Currently the valuse are clipped to the [0.0, 1.0] range</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Move coordinates into window space (in pixels)</span></div>
<div class="line">        <a class="code" href="gl2ext_8h.html#abe1577120f1766eff913e9a74879f373">x</a> *= (<a class="code" href="hiz__cull_8cs.html#a2ab77c89eb79b49ccd22bb1b2ad48bf1">float</a>) aViewportWidth;</div>
<div class="line">        <a class="code" href="gl2ext_8h.html#a1675d9d7bb68e1657ff028643b4037e3">y</a> *= (<a class="code" href="hiz__cull_8cs.html#a2ab77c89eb79b49ccd22bb1b2ad48bf1">float</a>) aViewportHeight;</div>
<div class="line">    }</div>
</div><!-- fragment --> <h1><a class="anchor" id="highQualityTextTextureGeneration"></a>
Texture Generation</h1>
<p>As we already know the font size we can estimate a size for our destination image. The image has to be large enough to store the whole text without any cuts. On the other hand it cannot be too big because the following geometry calculations are based on the image size. We want to have a size fitted precisely to the content the font engine is going to produce.</p>
<p>The height calculation is simple because this is the size of the font, but such a width is very complex. To calculate the width properly we need to use the font engine to help us estimate it. Android Java SDK comes with the measureText method from the Paint object. Before the measurement happens we need to deliver all necessary data to the object like: name of a font, size of a font (which we already calculated), anti-aliasing, color ARGB (in our case it is always white because coloring may be done in the fragment shader later on), and other less important data.</p>
<p>Before we paint the text into a Bitmap object we need to clear its content using white color with an alpha entirely transparent ARGB = (0, 255, 255, 255). Having the background cleared with this color and Paint color set to white as well, prevents dark texels which might appear by alpha blending. If we are talking about blending it is important to mention about GL blending function which must be set properly before the text is rendered. The blend function must be set as: <code>glBlendFunc(GL_ONE, GL_ONE_MINUS_SRC_ALPHA)</code></p>
<p>The function below does all the steps mentioned above:</p>
<div class="fragment"><div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> drawCanvasToTexture(</div>
<div class="line">                String aText,</div>
<div class="line">                <span class="keywordtype">float</span> aFontSize) {</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (aFontSize &lt; 8.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>)</div>
<div class="line">                aFontSize = 8.0f;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (aFontSize &gt; 500.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>)</div>
<div class="line">                aFontSize = 500.0f;</div>
<div class="line"></div>
<div class="line">            Paint textPaint = <span class="keyword">new</span> Paint();</div>
<div class="line">            textPaint.setTextSize(aFontSize);</div>
<div class="line">            textPaint.setFakeBoldText(<span class="keyword">false</span>);</div>
<div class="line">            textPaint.setAntiAlias(<span class="keyword">true</span>);</div>
<div class="line">            textPaint.setARGB(255, 255, 255, 255);</div>
<div class="line">                        <span class="comment">// If a hinting is available on the platform you are developing, you should enable it (uncomment the line below).</span></div>
<div class="line">            <span class="comment">//textPaint.setHinting(Paint.HINTING_ON);</span></div>
<div class="line">            textPaint.setSubpixelText(<span class="keyword">true</span>);</div>
<div class="line">            textPaint.setXfermode(<span class="keyword">new</span> PorterDuffXfermode(<a class="code" href="namespace_g_l_f_f_t.html#a759b6358f2b9bb2ff170db9ceaa17419">Mode</a>.SCREEN));</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">float</span> realTextWidth = textPaint.measureText(aText);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Creates a new mutable bitmap, with 128px of width and height</span></div>
<div class="line">            bitmapWidth = (<a class="code" href="hiz__cull_8cs.html#ad4c740ec72b16a35038e3b75d175014f">int</a>)(realTextWidth + 2.0<a class="code" href="gl2ext_8h.html#a7a611b28eaed9ea8dda79c38887b3f0e">f</a>);</div>
<div class="line">            bitmapHeight = (<a class="code" href="hiz__cull_8cs.html#ad4c740ec72b16a35038e3b75d175014f">int</a>)aFontSize + 2;</div>
<div class="line"></div>
<div class="line">            Bitmap textBitmap = Bitmap.createBitmap(bitmapWidth, bitmapHeight, Bitmap.Config.ARGB_8888);</div>
<div class="line">            textBitmap.eraseColor(Color.argb(0, 255, 255, 255));</div>
<div class="line">            <span class="comment">// Creates a new canvas that will draw into a bitmap instead of rendering into the screen</span></div>
<div class="line">            Canvas bitmapCanvas = <span class="keyword">new</span> Canvas(textBitmap);</div>
<div class="line">            <span class="comment">// Set start drawing position to [1, base_line_position]</span></div>
<div class="line">            <span class="comment">// The base_line_position may vary from one font to another but it usually is equal to 75% of font size (height).</span></div>
<div class="line">            bitmapCanvas.drawText(aText, 1, 1.0f + aFontSize * 0.75f, textPaint);</div>
<div class="line"></div>
<div class="line">            GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, <a class="code" href="tutorials_2_normal_mapping_2jni_2_native_8cpp.html#a748ff5115c8b3b65daec06945c822353">textureId</a>[0]);</div>
<div class="line">            HighQualityTextRenderer.checkGLError(<span class="stringliteral">&quot;glBindTexture&quot;</span>);</div>
<div class="line">            <span class="comment">// Assigns the OpenGL texture with the Bitmap</span></div>
<div class="line">            GLUtils.texImage2D(GLES20.GL_TEXTURE_2D, 0, GLES20.GL_RGBA, textBitmap, 0);</div>
<div class="line">            <span class="comment">// Free memory resources associated with this texture</span></div>
<div class="line">            textBitmap.recycle();</div>
<div class="line"></div>
<div class="line">            <span class="comment">// After the image has been subloaded to texture, regenerate mipmaps</span></div>
<div class="line">            GLES20.glGenerateMipmap(GLES20.GL_TEXTURE_2D);</div>
<div class="line">            HighQualityTextRenderer.checkGLError(<span class="stringliteral">&quot;glGenerateMipmap&quot;</span>);</div>
<div class="line">        }</div>
</div><!-- fragment --> <h1><a class="anchor" id="highQualityTextFurtherImprovements"></a>
Further Improvements</h1>
<ul>
<li>If the text is being changed frequently in your program this concept might fit that as well. We can suggest creating a separate thread which is going to update the texture continuously with some interval. In most cases it would be mostly desired to keep the thread on lowest possible priority since generating text is always considered as heavyweight operation which is more likely cause a disruption in performance. Needless to say that updating a texture should be done on the thread which serves the GL context.</li>
<li>If you are rendering the text along a Bezier curve or you are doing some displacements, you need to have size of font estimated more precisely. For this purpose increase rectangle resolution horizontally. At this point the rectangle will be split into vertical slices. Then evaluate average height of all these slices. The average height value is used to increase precision of the font size. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">
        <a class="copyright" href="http://www.arm.com/">(C) ARM Ltd. 2017</a>
    </li>
  </ul>
</div>
</body>
</html>
